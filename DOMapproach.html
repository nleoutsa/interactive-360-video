<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>Hapyak A-Frame Example</title>
        <script src="vendor/aframe-0.1.3.js"></script>
        <script src="vendor/jquery-2.2.2.js"></script>
        <script src="vendor/html2canvas.js"></script>
        <script src="vendor/projector.js"></script> <!-- include projector.js since it's been removed from THREE. There should be a newer way to accomplish this -->
        <script src="vendor/canvasRenderer.js"></script> <!-- include canvasRenderer.js since it's been removed from THREE. There should be a newer way to accomplish this -->

        <style type="text/css">
            .textAnnotation {
                position: absolute;
                color: #fff;
                background-color: #db6327;
                border: 5px solid #333;
                text-align: center;
                font-size: 18px;
                padding: 10px;
                width: 100px;
                height: 50px;
                z-index: 99;
                transform: translateX(-50%) translateY(-50%);
            }
            #annotationsContainer {
                position: absolute;
                z-index: 99;
                transform-style: preserve-3d;
                transform: translateX(50vw) translateY(50vh);
            }
        </style>
    </head>
    <body>

        <div id="aSceneContainer"></div>

        <div id="annotationsContainer"></div>

        <script type="text/javascript">
            var WIDTH = window.innerWidth;
            var HEIGHT = window.innerHeight;

            var projector = new THREE.Projector();

            var aSceneContainer = document.getElementById('aSceneContainer');
            var annotationsContainer = document.getElementById('annotationsContainer');

            var annotationList = []; // will come from hapyak annotation list
            var annotation3DObjects = [];

            var aScene,
                aMark,
                cameraElement,
                camera,
                raycaster,
                mouse,
                renderer;

            function getAnnotations () {
                // for now, create fake pop annotation
                var annotationWrapper = document.createElement('div');
                var popAnnotation = document.createElement('div');
                annotationWrapper.appendChild(popAnnotation);
                var popLink = document.createElement('a');
                popLink.setAttribute('href', 'http://www.hapyak.com')
                popLink.innerHTML = "HapYak";
                popAnnotation.appendChild(popLink);
                annotationWrapper.className = "textAnnotation";
                annotationWrapper.id = "textAnnotation";
                annotationList.push(annotationWrapper);
            }

            function updateAnnotations (cycles) {
                window.requestAnimationFrame(function () {
                    var coords = get2DCoordinates(aMark);

                    camRotX = cameraElement.components.rotation.data.x;
                    camRotY = cameraElement.components.rotation.data.y;

                    annotationsContainer.style.transform = 'translateZ(' + 100 + 'px) translateX(' + coords.x + 'px) translateY(' + coords.y + 'px)'; //' rotateY(' + camRotY + 'deg)';

                    updateAnnotations(cycles + 1);
                });
            }


            function addAnnotationsToScene() {
                getAnnotations();
                for (index in annotationList) {
                    annotationsContainer.appendChild(annotationList[index]);
                }
            }

            function createAFramePlaceholder (annotation) {

                var aImage = document.createElement('a-image');
                aImage.setAttribute('id', annotation.id);
                aImage.setAttribute('look-at', '[camera]');
                aImage.setAttribute('position', '0 0 -7');
                aImage.setAttribute('linkUrl', annotation.childNodes[0].childNodes[0].href);

                html2canvas(annotation, {
                    onrendered: function(canvas) {
                        var imageUrl = canvas.toDataURL("image/png");

                        aImage.setAttribute('src', imageUrl);
                        aImage.setAttribute('width', canvas.width / 100);
                        aImage.setAttribute('height', canvas.height / 100);
                    }
                });

                aImage.addEventListener('mouseup', function (e) {
                    if (e) {
                        if (aImage.getAttribute('linkUrl')) {
                            window.open(aImage.getAttribute('linkUrl'),'_blank');
                        }
                    }
                });

                return aImage;
            }

            function get2DCoordinates(placeholder) {

                var coords = {};

                var position3D,
                    vector2D,
                    percentX,
                    percentY;

                var vector = new THREE.Vector3();
                // Get webgl object's position relative to world
                // position3D = placeholder.object3D.matrixWorld.getPosition().clone();
                vector.setFromMatrixPosition(placeholder.object3D.matrixWorld);

                // // use 'project' to translate position to 2D view that the perspective camera renders
                vector2D = vector.project(camera);

                // translate vector so that
                // vector2D.x & vector2D.y have range [-1, 1].
                // add 1 to them and divide by 2 so 0 represents left & top edges
                // and 1 represents right & bottom edges
                // then multiply by screen width or height to get pixel value
                coords.x = ((vector2D.x + 1) / 2) * WIDTH;
                coords.y = ((-vector2D.y + 1) / 2) * HEIGHT;

                return coords;
            }

            function createAFrame360Scene() {
                aScene = document.createElement('a-scene');

                var aCameraContainer = document.createElement('a-entity');
                aCameraContainer.setAttribute('position', '0 0 0');
                aCameraContainer.innerHTML = "<a-entity camera look-controls id='main-camera'></a-entity>";

                aScene.appendChild(aCameraContainer);

                aMark = document.createElement('a-plane');
                aMark.setAttribute('id', 'aMark');
                aMark.setAttribute('position', '7 7 -7');
                aMark.setAttribute('look-at', '[camera]');
                aMark.setAttribute('width', '0.1');
                aMark.setAttribute('height', '0.1');
                aScene.appendChild(aMark);

                var aVideosphere = document.createElement('a-videosphere');
                aVideosphere.setAttribute('src', 'videos/car.mp4');
                // aVideosphere.setAttribute('autoplay', 'true');
                aScene.appendChild(aVideosphere);

                addAnnotationsToScene();

                aSceneContainer.appendChild(aScene);
            }

            createAFrame360Scene();

            window.addEventListener("loaded", function (e, t) {
                cameraElement = document.getElementById('main-camera');
                camera = cameraElement.object3D.children[0]; // get actual THREE.js perspective camera...

                updateAnnotations(0);
            });

        </script>
    </body>
</html>
